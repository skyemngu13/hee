local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local Camera = game.Workspace.CurrentCamera

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")
local enemies = workspace.__Main.__Enemies.Server:WaitForChild("7") -- C·∫≠p nh·∫≠t th√†nh Map 7

local speed, tween = 1000, nil

-- üîç T√¨m mob g·∫ßn nh·∫•t c√≤n s·ªëng v√† c√≥ Scale = 2
local function findNearestMob()
    local nearest, minDist = nil, math.huge
    for _, mob in pairs(enemies:GetChildren()) do
        local hp = mob:GetAttribute("HP")
        local scale = mob:GetAttribute("Scale") -- L·∫•y gi√° tr·ªã Scale
        if hp and hp > 0 and scale == 2 then -- Ch·ªâ ch·ªçn mob c√≥ Scale = 2
            local dist = (mob.Position - rootPart.Position).Magnitude
            if dist < minDist then
                minDist, nearest = dist, mob
            end
        end
    end
    return nearest
end

-- üëä G·ª≠i remote PunchAttack
local function punchMob(uuid)
    local args = {
        [1] = {
            [1] = {
                ["Event"] = "PunchAttack",
                ["Enemy"] = uuid
            },
            [2] = "\4"
        }
    }
    ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer(unpack(args))
end

-- üí• G·ª≠i remote EnemyDestroy 3 l·∫ßn (delay 0.1s)
local function destroyMob(uuid)
    for i = 1, 4 do
        local args = {
            [1] = {
                [1] = {
                    ["Event"] = "EnemyDestroy",
                    ["Enemy"] = uuid
                },
                [2] = "\4"
            }
        }
        ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer(unpack(args))
        task.wait(0.2)
    end
end

-- ‚úàÔ∏è Bay t·ªõi mob v√† t·∫•n c√¥ng sau 0.5s
local function moveToAndPunch(mob)
    if tween then tween:Cancel() end

    local uuid = mob:GetAttribute("UUID") or mob.Name
    local distance = (mob.Position - rootPart.Position).Magnitude
    local tweenTime = distance / speed

    -- B·∫Øt ƒë·∫ßu tween bay ƒë·∫øn mob
    local finished = false
    tween = TweenService:Create(rootPart, TweenInfo.new(tweenTime, Enum.EasingStyle.Linear), {CFrame = mob.CFrame})
    tween.Completed:Connect(function()
        finished = true
    end)
    tween:Play()
   
    local connection
    connection = RunService.Heartbeat:Connect(function()
        if not mob or not mob.Parent then
            connection:Disconnect()
            return
        end

        local hp = mob:GetAttribute("HP")
        if not hp or hp <= 0 then
            connection:Disconnect()
            destroyMob(uuid)
            return
        end

        punchMob(uuid)
    end)
end

local mainFolder = game.Workspace:FindFirstChild("__Main")
if mainFolder then
    local world = mainFolder:FindFirstChild("__World")
    if world then
        world:Destroy()
    end
end

-- Xo√° __Effects, __Rain, v√† __Ocean trong __Extra
local extraFolder = game.Workspace:FindFirstChild("__Extra")
if extraFolder then
    local effects = extraFolder:FindFirstChild("Radars")
    if effects then
        effects:Destroy()
    end

    local rain = extraFolder:FindFirstChild("__Rain")
    if rain then
        rain:Destroy()
    end

    local ocean = extraFolder:FindFirstChild("__Ocean")
    if ocean then
        ocean:Destroy()
    end
end

-- üîí Kh√≥a camera c·ªßa ng∆∞·ªùi ch∆°i t·∫°i v·ªã tr√≠ c·ª• th·ªÉ (5457, 641, -127) v√† nh√¨n xu·ªëng
local function lockCamera()
    local targetPosition = Vector3.new(5457, 641, -127) -- V·ªã tr√≠ mu·ªën kh√≥a camera
    local cameraOffset = Vector3.new(0, 5, 20) -- ƒêi·ªÅu ch·ªânh g√≥c nh√¨n (cao h∆°n v√† nh√¨n xu·ªëng)

    Camera.CameraType = Enum.CameraType.Scriptable
    Camera.CFrame = CFrame.new(targetPosition + cameraOffset, targetPosition) -- C·∫≠p nh·∫≠t CFrame ƒë·ªÉ nh√¨n xu·ªëng v·ªã tr√≠
end

-- üîÅ V√≤ng l·∫∑p ch√≠nh
while task.wait(0.2) do
    -- Kh√≥a camera ·ªü v·ªã tr√≠ c·∫ßn thi·∫øt
    lockCamera()

    local mob = findNearestMob()
    if mob then
        moveToAndPunch(mob)
    end
end
