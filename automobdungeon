local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local enemies = workspace:WaitForChild("__Main"):WaitForChild("__Enemies"):WaitForChild("Server")

local speed = 1000
local tween = nil
local reachedMob = nil
local heartbeatConnection = nil

-- Luôn cập nhật lại rootPart khi nhân vật respawn
local function getRootPart()
    local char = player.Character or player.CharacterAdded:Wait()
    return char:WaitForChild("HumanoidRootPart")
end

-- Tìm mob gần nhất
local function findNearestMob()
    local nearest, minDist = nil, math.huge
    local rootPart = getRootPart()

    for _, mob in pairs(enemies:GetChildren()) do
        local hp = mob:GetAttribute("HP")
        if hp and hp > 0 and mob:IsA("Model") and mob:FindFirstChild("HumanoidRootPart") then
            local dist = (mob.HumanoidRootPart.Position - rootPart.Position).Magnitude
            if dist < minDist then
                minDist = dist
                nearest = mob
            end
        end
    end

    return nearest
end

-- Di chuyển đến mob
local function moveToMob(mob)
    if tween then tween:Cancel() end
    if heartbeatConnection then heartbeatConnection:Disconnect() end

    local rootPart = getRootPart()
    local targetPos = mob:FindFirstChild("HumanoidRootPart")
    if not targetPos then return end

    local distance = (targetPos.Position - rootPart.Position).Magnitude
    local tweenTime = distance / speed

    tween = TweenService:Create(rootPart, TweenInfo.new(tweenTime, Enum.EasingStyle.Linear), {
        CFrame = targetPos.CFrame
    })
    tween:Play()

    heartbeatConnection = RunService.Heartbeat:Connect(function()
        if not mob or not mob.Parent then
            heartbeatConnection:Disconnect()
            reachedMob = nil
            return
        end

        local hp = mob:GetAttribute("HP")
        if not hp or hp <= 0 then
            heartbeatConnection:Disconnect()
            reachedMob = nil
            task.wait(0.2)
        end
    end)

    tween.Completed:Connect(function()
        if not reachedMob then
            reachedMob = mob
        end
    end)
end

-- Vòng lặp chính
while task.wait(0.3) do
    if not reachedMob then
        local mob = findNearestMob()
        if mob then
            moveToMob(mob)
        end
    end
end
