local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")
local enemies = workspace.__Main.__Enemies.Server

local speed, tween = 1000, nil
local reachedMob = nil  -- Đánh dấu quái đã đến

-- Find the nearest mob
local function findNearestMob()
    local nearest, minDist = nil, math.huge
    for _, mob in pairs(enemies:GetChildren()) do
        local hp = mob:GetAttribute("HP")
        if hp and hp > 0 then
            local dist = (mob.Position - rootPart.Position).Magnitude
            if dist < minDist then
                minDist, nearest = dist, mob
            end
        end
    end
    return nearest
end

-- Destroy the mob
local function destroyMob(uuid)
    for i = 1, 5 do
        local args = { [1] = { [1] = { ["Event"] = "EnemyDestroy", ["Enemy"] = uuid }, [2] = "\4" } }
        ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer(unpack(args))
        task.wait(0.2)
    end
end

-- Arise the mob
local function ariseMob(uuid)
    for i = 1, 5 do
        local args = { [1] = { [1] = { ["Event"] = "EnemyCapture", ["Enemy"] = uuid }, [2] = "\4" } }
        ReplicatedStorage.BridgeNet2.dataRemoteEvent:FireServer(unpack(args))
        task.wait(0.2)
    end
end

-- Move to the mob and monitor HP, but DO NOT punch
local function moveToMob(mob)
    -- Nếu đang tween, hủy tween cũ
    if tween then
        tween:Cancel()
    end

    local uuid = mob:GetAttribute("UUID") or mob.Name
    local distance = (mob.Position - rootPart.Position).Magnitude
    local tweenTime = distance / speed

    -- Tween một lần đến quái
    tween = TweenService:Create(rootPart, TweenInfo.new(tweenTime, Enum.EasingStyle.Linear), {CFrame = mob.CFrame})
    tween:Play()

    local finished = false
    tween.Completed:Connect(function()
        finished = true
    end)

    -- Chờ tween hoàn tất
    while not finished do
        task.wait()
    end

    task.wait(0.4)

    -- Đánh dấu quái đã đến, người chơi có thể tự do di chuyển
    reachedMob = mob

    -- Theo dõi HP quái
    local connection
    connection = RunService.Heartbeat:Connect(function()
        if not mob or not mob.Parent then
            connection:Disconnect()
            reachedMob = nil  -- Nếu quái chết, reset lại trạng thái
            return
        end

        local hp = mob:GetAttribute("HP")
        if not hp or hp <= 0 then
            connection:Disconnect()
            local model = mob:GetAttribute("Model")
            if model == "JinWoo" or model == "Pucci" or model == "Denji" then
                ariseMob(uuid)
            else
                destroyMob(uuid)
            end
            reachedMob = nil  -- Reset trạng thái khi quái chết
        end
    end)
end

-- Main loop
while task.wait(0.3) do
    -- Nếu không có quái nào được đánh dấu đã đến, tìm và di chuyển đến quái tiếp theo
    if not reachedMob then
        local mob = findNearestMob()
        if mob then
            moveToMob(mob)
        end
    end
end
